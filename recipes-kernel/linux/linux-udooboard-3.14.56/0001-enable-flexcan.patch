From 82710693ca7fbbe072429b7fc222e240fe5a3e3c Mon Sep 17 00:00:00 2001
From: Frank Traenkle <frank.traenkle@hs-heilbronn.de>
Date: Thu, 23 Mar 2017 10:58:54 +0100
Subject: [PATCH] * enable flexcan

Signed-off-by: Frank Traenkle <frank.traenkle@hs-heilbronn.de>
---
 .../arm/boot/dts/imx6sx-udoo-neo-externalpins.dtsi | 49 +++++++++++++++-------
 arch/arm/boot/dts/imx6sx-udoo-neo.dtsi             |  6 +++
 2 files changed, 39 insertions(+), 16 deletions(-)

diff --git a/arch/arm/boot/dts/imx6sx-udoo-neo-externalpins.dtsi b/arch/arm/boot/dts/imx6sx-udoo-neo-externalpins.dtsi
index 6225aa7..d31700c 100644
--- a/arch/arm/boot/dts/imx6sx-udoo-neo-externalpins.dtsi
+++ b/arch/arm/boot/dts/imx6sx-udoo-neo-externalpins.dtsi
@@ -17,8 +17,8 @@
 				MX6SX_PAD_NAND_DATA07__GPIO4_IO_11		0x80000000	// {{external-gpio-17}}
 				MX6SX_PAD_SD4_DATA6__GPIO6_IO_20		0x80000000	// {{external-gpio-18}}
 				MX6SX_PAD_SD4_DATA7__GPIO6_IO_21		0x80000000	// {{external-gpio-19}}
-				MX6SX_PAD_SD4_CLK__GPIO6_IO_12			0x80000000	// {{external-gpio-20}}
-				MX6SX_PAD_SD4_CMD__GPIO6_IO_13			0x80000000	// {{external-gpio-21}}
+// ESPI2			MX6SX_PAD_SD4_CLK__GPIO6_IO_12			0x80000000	// {{external-gpio-20}}
+// ESPI2			MX6SX_PAD_SD4_CMD__GPIO6_IO_13			0x80000000	// {{external-gpio-21}}
 				MX6SX_PAD_SD4_RESET_B__GPIO6_IO_22		0x80000000	// {{external-gpio-22}}
 				MX6SX_PAD_CSI_PIXCLK__GPIO1_IO_24		0x80000000	// {{external-gpio-23}}	
 						
@@ -33,21 +33,22 @@
 				MX6SX_PAD_CSI_DATA06__GPIO1_IO_20		0x80000000	// {{external-gpio-32}}
 				MX6SX_PAD_CSI_DATA07__GPIO1_IO_21		0x80000000	// {{external-gpio-33}}
 				
-				//MX6SX_PAD_USB_H_STROBE__GPIO7_IO_11	0x80000000	// {{external-gpio-34}}
-				//MX6SX_PAD_USB_H_DATA__GPIO7_IO_10		0x80000000	// {{external-gpio-35}}
+// 				MX6SX_PAD_USB_H_STROBE__GPIO7_IO_11	0x80000000	// {{external-gpio-34}}
+// 				MX6SX_PAD_USB_H_DATA__GPIO7_IO_10		0x80000000	// {{external-gpio-35}}
 				MX6SX_PAD_SD4_DATA3__GPIO6_IO_17		0x80000000	// {{external-gpio-36}}
 				MX6SX_PAD_SD4_DATA2__GPIO6_IO_16		0x80000000	// {{external-gpio-37}}
-				MX6SX_PAD_SD4_DATA1__GPIO6_IO_15		0x80000000	// {{external-gpio-38}}
-				MX6SX_PAD_SD4_DATA0__GPIO6_IO_14		0x80000000	// {{external-gpio-39}}
+// SPI2				MX6SX_PAD_SD4_DATA1__GPIO6_IO_15		0x80000000	// {{external-gpio-38}}
+// SPI2				MX6SX_PAD_SD4_DATA0__GPIO6_IO_14		0x80000000	// {{external-gpio-39}}
 				
-				MX6SX_PAD_QSPI1A_SS1_B__GPIO4_IO_23		0x80000000	// {{external-gpio-40}}
-				MX6SX_PAD_QSPI1B_DQS__GPIO4_IO_28		0x80000000	// {{external-gpio-41}}
-				MX6SX_PAD_QSPI1B_SS1_B__GPIO4_IO_31		0x80000000	// {{external-gpio-42}}
-				MX6SX_PAD_QSPI1A_DQS__GPIO4_IO_20		0x80000000	// {{external-gpio-43}}
+// CAN1				MX6SX_PAD_QSPI1A_SS1_B__GPIO4_IO_23		0x80000000	// {{external-gpio-40}}
+// CAN1				MX6SX_PAD_QSPI1B_DQS__GPIO4_IO_28		0x80000000	// {{external-gpio-41}}
+// CAN2				MX6SX_PAD_QSPI1B_SS1_B__GPIO4_IO_31		0x80000000	// {{external-gpio-42}}
+// CAN2				MX6SX_PAD_QSPI1A_DQS__GPIO4_IO_20		0x80000000	// {{external-gpio-43}}
 				MX6SX_PAD_GPIO1_IO07__GPIO1_IO_7		0x80000000	// {{external-gpio-44}}
 				MX6SX_PAD_GPIO1_IO06__GPIO1_IO_6		0x80000000	// {{external-gpio-45}}
-				//MX6SX_PAD_GPIO1_IO05__GPIO1_IO_5		0x80000000	// {{external-gpio-46}}
-				//MX6SX_PAD_GPIO1_IO04__GPIO1_IO_4		0x80000000	// {{external-gpio-47}}
+ 				MX6SX_PAD_GPIO1_IO05__GPIO1_IO_5		0x80000000	// {{external-gpio-46}}
+				MX6SX_PAD_GPIO1_IO04__GPIO1_IO_4		0x80000000	// {{external-gpio-47}}
+// MCP CAN Interrupt    	MX6SX_PAD_RGMII2_TD1__GPIO5_IO_19		0x80000000	// {{internal-gpio-11}} 
 			>;
 		};
 
@@ -142,6 +143,12 @@
 			>;
 		};
 
+		pinctrl_mcpcan1: mcpcan1grp {
+			fsl,pins = <
+				MX6SX_PAD_RGMII2_TD1__GPIO5_IO_19	0x80000000
+			>;
+		};
+
 		pinctrl_spdif: spdifgrp {
 			fsl,pins = <
 				MX6SX_PAD_CSI_DATA04__SPDIF_OUT		0x1b0b0
@@ -166,13 +173,23 @@
 	cs-gpios = <&gpio6 14 0>;
 	pinctrl-names = "default";
 	pinctrl-0 = <&pinctrl_ecspi2>;
-	status = "disabled";
+	status = "okay";
+        can2: mcp2515@0 {
+                reg = <0>;
+                compatible = "microchip,mcp2515";
+                pinctrl-names = "default";
+                pinctrl-0 = <&pinctrl_mcpcan1>;
+                spi-max-frequency = <10000000>;
+                interrupt-parent = <&gpio5>;
+                interrupts = <19 0x2>;
+                clocks = <&mcpcan1_osc>;
+        };
 };
 
 &uart1 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&pinctrl_uart1>;
-	status = "okay";
+	status = "disabled";
 };
 
 &uart2 {
@@ -199,13 +216,13 @@
 &flexcan1 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&pinctrl_flexcan1>;
-	status = "disabled";
+	status = "okay";
 };
 
 &flexcan2 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&pinctrl_flexcan2>;
-	status = "disabled";
+	status = "okay";
 };
 
 &spdif {
diff --git a/arch/arm/boot/dts/imx6sx-udoo-neo.dtsi b/arch/arm/boot/dts/imx6sx-udoo-neo.dtsi
index 1a7a45e..d4ad255 100644
--- a/arch/arm/boot/dts/imx6sx-udoo-neo.dtsi
+++ b/arch/arm/boot/dts/imx6sx-udoo-neo.dtsi
@@ -25,6 +25,12 @@
 		status = "disabled";
 	};
 
+	mcpcan1_osc: mcpcan1_osc {
+                compatible = "fixed-clock";
+                #clock-cells = <0>;
+                clock-frequency  = <16000000>;
+        };
+
 	regulators {
 		compatible = "simple-bus";
 
-- 
1.9.1

